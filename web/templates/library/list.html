{% extends "base.html" %}

{% block title %}Shelf - Library{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/library.css') }}">
{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="library-header">
        <div class="header-title-row">
            <h2>Library Status</h2>
            <a href="/settings" class="settings-link">Settings</a>
        </div>
        <div class="library-stats">
            <div class="stat-item">
                <strong>{{ books|length }}</strong> books in library
            </div>
            <div class="stat-item">
                {% if library_total_runtime < 60 %}
                    <strong>{{ "%.1f"|format(library_total_runtime) }}s</strong> total time
                {% elif library_total_runtime < 3600 %}
                    <strong>{{ "%.1f"|format(library_total_runtime / 60) }}m</strong> total time
                {% else %}
                    <strong>{{ "%.1f"|format(library_total_runtime / 3600) }}h</strong> total time
                {% endif %}
            </div>
            <div class="stat-item">
                <strong>${{ "%.2f"|format(library_total_cost) }}</strong> total cost
            </div>
        </div>
    </div>

    {% if books %}
    <table class="status-table">
        <thead>
            <tr>
                <th style="width: 14%;">Book</th>
                <th style="width: 7%;">Total Time</th>
                <th style="width: 7%;">Total Cost</th>
                <th style="width: 9%;">OCR Pages</th>
                <th style="width: 9%;">Extract ToC</th>
                <th style="width: 9%;">Label Structure</th>
                <th style="width: 9%;">Link ToC</th>
                <th style="width: 9%;">Structure</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <!-- Book Name -->
                <td>
                    <div class="book-name">{{ book.scan_id }}</div>
                </td>

                <!-- Total Time -->
                <td>
                    {% if book.total_runtime_seconds > 0 %}
                        {% if book.total_runtime_seconds < 60 %}
                            {{ "%.1fs"|format(book.total_runtime_seconds) }}
                        {% elif book.total_runtime_seconds < 3600 %}
                            {{ "%.1fm"|format(book.total_runtime_seconds / 60) }}
                        {% else %}
                            {{ "%.1fh"|format(book.total_runtime_seconds / 3600) }}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <!-- Total Cost -->
                <td>
                    {% if book.total_cost_usd > 0 %}
                        ${{ "%.2f"|format(book.total_cost_usd) }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <!-- OCR Pages Status -->
                <td>
                    {% set stage_data = book.stages.get('ocr-pages', {}) %}
                    {% set status = stage_data.get('status', 'not_started') %}
                    {% set cost_usd = stage_data.get('cost_usd', 0.0) %}
                    {% set runtime_seconds = stage_data.get('runtime_seconds', 0.0) %}
                    {% if status in ['completed', 'in_progress'] %}
                        {% set link = '/stage/' ~ book.scan_id ~ '/ocr-pages' %}
                    {% endif %}
                    {% include 'components/status_badge.html' %}
                </td>

                <!-- Extract ToC Status -->
                <td>
                    {% set stage_data = book.stages.get('extract-toc', {}) %}
                    {% set status = stage_data.get('status', 'not_started') %}
                    {% set cost_usd = stage_data.get('cost_usd', 0.0) %}
                    {% set runtime_seconds = stage_data.get('runtime_seconds', 0.0) %}
                    {% if status in ['completed', 'in_progress'] %}
                        {% set link = '/stage/' ~ book.scan_id ~ '/extract-toc' %}
                    {% endif %}
                    {% include 'components/status_badge.html' %}
                </td>

                <!-- Label Structure Status -->
                <td>
                    {% set stage_data = book.stages.get('label-structure', {}) %}
                    {% set status = stage_data.get('status', 'not_started') %}
                    {% set cost_usd = stage_data.get('cost_usd', 0.0) %}
                    {% set runtime_seconds = stage_data.get('runtime_seconds', 0.0) %}
                    {% if status in ['completed', 'in_progress'] %}
                        {% set link = '/stage/' ~ book.scan_id ~ '/label-structure' %}
                    {% endif %}
                    {% include 'components/status_badge.html' %}
                </td>

                <!-- Link ToC Status -->
                <td>
                    {% set stage_data = book.stages.get('link-toc', {}) %}
                    {% set status = stage_data.get('status', 'not_started') %}
                    {% set cost_usd = stage_data.get('cost_usd', 0.0) %}
                    {% set runtime_seconds = stage_data.get('runtime_seconds', 0.0) %}
                    {% if status in ['completed', 'in_progress'] %}
                        {% set link = '/stage/' ~ book.scan_id ~ '/link-toc' %}
                    {% endif %}
                    {% include 'components/status_badge.html' %}
                </td>

                <!-- Common Structure Status -->
                <td>
                    {% set stage_data = book.stages.get('common-structure', {}) %}
                    {% set status = stage_data.get('status', 'not_started') %}
                    {% set cost_usd = stage_data.get('cost_usd', 0.0) %}
                    {% set runtime_seconds = stage_data.get('runtime_seconds', 0.0) %}
                    {% if status in ['completed', 'in_progress'] %}
                        {% set link = '/stage/' ~ book.scan_id ~ '/common-structure' %}
                    {% endif %}
                    {% include 'components/status_badge.html' %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No books in library</h3>
        <p>Use <code>shelf library add &lt;pdf&gt;</code> to add books to your library.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
