{% extends "base.html" %}

{% block title %}{{ scan_id }} - Find ToC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stage.css') }}">
<style>
    /* Two-column layout: TOC pages on left, finder report on right */
    .toc-viewer-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    /* Left column: TOC page images */
    .toc-pages-column {
        border-right: 2px solid #e0e0e0;
        padding-right: 2rem;
    }

    .toc-pages-column h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .page-image-container {
        margin-bottom: 2rem;
        background: #f9f9f9;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .page-number-label {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 1rem;
    }

    .page-image {
        width: 100%;
        height: auto;
        display: block;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 4px;
    }

    /* Right column: Finder report */
    .finder-report-column {
        padding-left: 2rem;
    }

    .finder-report-column h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    /* Status summary at top */
    .finder-summary {
        background: #f0f8ff;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #b3d9ff;
    }

    .finder-summary.not-found {
        background: #fff5f5;
        border-color: #ffcccc;
    }

    .summary-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .status-icon {
        font-size: 2rem;
    }

    .status-text h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1.25rem;
    }

    .status-text .confidence {
        color: #666;
        font-size: 0.95rem;
    }

    .confidence-value {
        font-weight: bold;
        color: #00aa00;
    }

    .confidence-value.low {
        color: #ff6600;
    }

    .page-range {
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 4px;
        display: inline-block;
        margin-top: 0.5rem;
        border: 1px solid #ddd;
    }

    .page-range strong {
        color: #0066cc;
        margin-right: 0.5rem;
    }

    /* Metadata grid */
    .finder-metadata {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .metadata-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .metadata-card h5 {
        margin: 0 0 0.5rem 0;
        color: #666;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metadata-card .value {
        font-size: 1.25rem;
        font-weight: bold;
        color: #333;
    }

    /* Reasoning section */
    .reasoning-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        margin-bottom: 1.5rem;
    }

    .reasoning-section h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: #333;
    }

    .reasoning-text {
        color: #444;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    /* Structure summary */
    .structure-summary {
        background: #f9f9f9;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        margin-bottom: 1.5rem;
    }

    .structure-summary h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: #333;
    }

    .levels-info {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
    }

    .levels-count {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0066cc;
        margin-bottom: 0.5rem;
    }

    .level-pattern {
        background: white;
        padding: 1rem;
        border-left: 4px solid #0066cc;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .level-pattern.level-1 {
        border-left-color: #0066cc;
    }

    .level-pattern.level-2 {
        border-left-color: #66b3ff;
    }

    .level-pattern.level-3 {
        border-left-color: #b3d9ff;
    }

    .level-pattern h5 {
        margin: 0 0 0.75rem 0;
        color: #333;
        font-size: 1rem;
    }

    .pattern-detail {
        margin-bottom: 0.5rem;
        color: #555;
        font-size: 0.9rem;
    }

    .pattern-detail strong {
        color: #333;
        margin-right: 0.5rem;
    }

    .pattern-badge {
        display: inline-block;
        background: #e0e0e0;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.85rem;
        color: #666;
    }

    .pattern-badge.has-pages {
        background: #d4edda;
        color: #155724;
    }

    .pattern-badge.no-pages {
        background: #f8d7da;
        color: #721c24;
    }

    .consistency-notes {
        background: #fff9e6;
        padding: 1rem;
        border-left: 4px solid #ffcc00;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .consistency-notes h5 {
        margin: 0 0 0.75rem 0;
        color: #996600;
    }

    .consistency-notes ul {
        margin: 0;
        padding-left: 1.5rem;
    }

    .consistency-notes li {
        color: #666;
        margin-bottom: 0.25rem;
    }

    /* Structure notes per page */
    .structure-notes {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .structure-notes h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: #333;
    }

    .page-note {
        background: #f9f9f9;
        padding: 0.75rem 1rem;
        border-left: 3px solid #0066cc;
        margin-bottom: 0.75rem;
        border-radius: 4px;
    }

    .page-note-header {
        font-weight: bold;
        color: #0066cc;
        margin-bottom: 0.25rem;
    }

    .page-note-text {
        color: #555;
        font-size: 0.9rem;
    }

    /* Empty states */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px dashed #ccc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-wide">
    <!-- Header -->
    <div class="stage-header">
        <div class="breadcrumb">
            <a href="/">‚Üê Library</a>
            <span class="separator">/</span>
            <span>{{ scan_id }}</span>
            <span class="separator">/</span>
            <span class="current">find-toc</span>
        </div>

        <h2>üîç Find Table of Contents</h2>

        <div class="book-info">
            <strong>{{ metadata.title }}</strong>
            {% if metadata.author %}
                <span class="author">by {{ metadata.author }}</span>
            {% endif %}
            {% if metadata.year %}
                <span class="year">({{ metadata.year }})</span>
            {% endif %}
        </div>
    </div>

    <!-- Two-column layout: TOC pages left, finder report right -->
    <div class="toc-viewer-layout">
        <!-- Left Column: TOC Page Images -->
        <div class="toc-pages-column">
            <h3>TOC Pages</h3>
            {% if page_numbers %}
                {% for page_num in page_numbers %}
                    <div class="page-image-container">
                        <div class="page-number-label">Page {{ page_num }}</div>
                        <img
                            src="{{ url_for('stage.serve_source_image', scan_id=scan_id, page_num=page_num) }}"
                            alt="Page {{ page_num }}"
                            class="page-image"
                        >
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>No TOC pages found</p>
                </div>
            {% endif %}
        </div>

        <!-- Right Column: Finder Report -->
        <div class="finder-report-column">
            <h3>Finder Report</h3>

            <!-- Status Summary -->
            <div class="finder-summary {% if not finder_data.toc_found %}not-found{% endif %}">
                <div class="summary-status">
                    <div class="status-icon">
                        {% if finder_data.toc_found %}‚úÖ{% else %}‚ùå{% endif %}
                    </div>
                    <div class="status-text">
                        <h4>
                            {% if finder_data.toc_found %}
                                Table of Contents Found
                            {% else %}
                                Table of Contents Not Found
                            {% endif %}
                        </h4>
                        <div class="confidence">
                            Confidence:
                            <span class="confidence-value {% if finder_data.confidence < 0.7 %}low{% endif %}">
                                {{ "%.0f"|format(finder_data.confidence * 100) }}%
                            </span>
                        </div>
                    </div>
                </div>

                {% if finder_data.toc_found and finder_data.toc_page_range %}
                <div class="page-range">
                    <strong>Pages:</strong>
                    {{ finder_data.toc_page_range.start_page }} - {{ finder_data.toc_page_range.end_page }}
                </div>
                {% endif %}
            </div>

            <!-- Metadata -->
            <div class="finder-metadata">
                <div class="metadata-card">
                    <h5>Search Strategy</h5>
                    <div class="value">{{ finder_data.search_strategy_used }}</div>
                </div>
                <div class="metadata-card">
                    <h5>Pages Checked</h5>
                    <div class="value">{{ finder_data.pages_checked }}</div>
                </div>
            </div>

            <!-- Reasoning -->
            <div class="reasoning-section">
                <h4>Analysis & Reasoning</h4>
                <div class="reasoning-text">{{ finder_data.reasoning }}</div>
            </div>

            <!-- Structure Summary (if available) -->
            {% if finder_data.structure_summary %}
            <div class="structure-summary">
                <h4>Structure Summary</h4>

                <div class="levels-info">
                    <div class="levels-count">
                        {{ finder_data.structure_summary.total_levels }} Hierarchy Level{% if finder_data.structure_summary.total_levels != 1 %}s{% endif %}
                    </div>
                </div>

                {% for level_num, pattern in finder_data.structure_summary.level_patterns.items() %}
                <div class="level-pattern level-{{ level_num }}">
                    <h5>Level {{ level_num }}{% if pattern.semantic_type %} - {{ pattern.semantic_type|capitalize }}{% endif %}</h5>

                    <div class="pattern-detail">
                        <strong>Visual:</strong> {{ pattern.visual }}
                    </div>

                    {% if pattern.numbering %}
                    <div class="pattern-detail">
                        <strong>Numbering:</strong> {{ pattern.numbering }}
                    </div>
                    {% endif %}

                    <div class="pattern-detail">
                        <strong>Page Numbers:</strong>
                        <span class="pattern-badge {% if pattern.has_page_numbers %}has-pages{% else %}no-pages{% endif %}">
                            {% if pattern.has_page_numbers %}Yes{% else %}No{% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}

                {% if finder_data.structure_summary.consistency_notes %}
                <div class="consistency-notes">
                    <h5>Consistency Notes</h5>
                    <ul>
                        {% for note in finder_data.structure_summary.consistency_notes %}
                        <li>{{ note }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Structure Notes per Page (if available) -->
            {% if finder_data.structure_notes %}
            <div class="structure-notes">
                <h4>Page-Level Notes</h4>
                {% for page_num, note in finder_data.structure_notes.items() %}
                <div class="page-note">
                    <div class="page-note-header">Page {{ page_num }}</div>
                    <div class="page-note-text">{{ note }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
