{% extends "base.html" %}

{% block title %}{{ scan_id }} - Page {{ page_num }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stage.css') }}">
<style>
    .page-viewer-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .page-image-column {
        border-right: 2px solid #e0e0e0;
        padding-right: 2rem;
    }

    .page-image-column h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .page-image-container {
        background: #f9f9f9;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .page-image {
        width: 100%;
        height: auto;
        display: block;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 4px;
    }

    .labels-column {
        padding-left: 2rem;
    }

    .labels-column h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .labels-grid {
        display: grid;
        gap: 1.5rem;
    }

    .label-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .label-section h4 {
        margin: 0 0 1rem 0;
        color: #0066cc;
        font-size: 1rem;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0.5rem;
    }

    .label-item {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .label-item:last-child {
        border-bottom: none;
    }

    .label-key {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
    }

    .label-value {
        color: #333;
        font-weight: 500;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-yes {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .text-muted {
        color: #999;
        font-style: italic;
    }

    .navigation {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
    }

    .nav-button {
        padding: 0.5rem 1rem;
        background: #0066cc;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .nav-button:hover {
        background: #0052a3;
    }

    .nav-button.disabled {
        background: #ccc;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="stage-header">
        <div class="breadcrumb">
            <a href="/">← Library</a>
            <span class="separator">/</span>
            <span>{{ scan_id }}</span>
            <span class="separator">/</span>
            <a href="{{ url_for('stage.label_structure_view', scan_id=scan_id) }}">label-structure</a>
            <span class="separator">/</span>
            <span class="current">Page {{ page_num }}</span>
        </div>

        <h2>Page {{ page_num }} Structure</h2>

        <div class="book-info">
            <strong>{{ metadata.title }}</strong>
            {% if metadata.author %}
                <span class="author">by {{ metadata.author }}</span>
            {% endif %}
        </div>
    </div>

    <div class="page-viewer-layout">
        <div class="page-image-column">
            <h3>Page Image</h3>
            <div class="page-image-container">
                <img
                    src="{{ url_for('stage.serve_source_image', scan_id=scan_id, page_num=page_num) }}"
                    alt="Page {{ page_num }}"
                    class="page-image"
                >
            </div>
        </div>

        <div class="labels-column">
            <h3>Page Structure</h3>

            <div class="labels-grid">
                <div class="label-section">
                    <h4>Page Number</h4>
                    <div class="label-item">
                        <span class="label-key">Present:</span>
                        <span class="label-value">
                            {% if labels.page_number.present %}
                                <span class="badge badge-yes">Yes</span>
                            {% else %}
                                <span class="text-muted">No</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if labels.page_number.present %}
                    <div class="label-item">
                        <span class="label-key">Number:</span>
                        <span class="label-value"><strong>{{ labels.page_number.number }}</strong></span>
                    </div>
                    {% if labels.page_number.location %}
                    <div class="label-item">
                        <span class="label-key">Location:</span>
                        <span class="label-value">{{ labels.page_number.location }}</span>
                    </div>
                    {% endif %}
                    {% if labels.page_number.reasoning %}
                    <div class="label-item">
                        <span class="label-key">Reasoning:</span>
                        <span class="label-value"><small>{{ labels.page_number.reasoning }}</small></span>
                    </div>
                    {% endif %}
                    <div class="label-item">
                        <span class="label-key">Source:</span>
                        <span class="label-value"><small class="text-muted">{{ labels.page_number.source_provider }}</small></span>
                    </div>
                    {% endif %}
                </div>

                <div class="label-section">
                    <h4>Running Header</h4>
                    <div class="label-item">
                        <span class="label-key">Present:</span>
                        <span class="label-value">
                            {% if labels.running_header.present %}
                                <span class="badge badge-yes">Yes</span>
                            {% else %}
                                <span class="text-muted">No</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if labels.running_header.present %}
                    <div class="label-item">
                        <span class="label-key">Text:</span>
                        <span class="label-value"><strong>{{ labels.running_header.text }}</strong></span>
                    </div>
                    {% if labels.running_header.reasoning %}
                    <div class="label-item">
                        <span class="label-key">Reasoning:</span>
                        <span class="label-value"><small>{{ labels.running_header.reasoning }}</small></span>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <div class="label-section">
                    <h4>Headings</h4>
                    <div class="label-item">
                        <span class="label-key">Found:</span>
                        <span class="label-value">
                            {% if labels.headings_present %}
                                <strong>{{ labels.headings|length }}</strong>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if labels.headings_present and labels.headings %}
                        {% for heading in labels.headings %}
                        <div class="label-item">
                            <span class="label-key">H{{ heading.level }}:</span>
                            <span class="label-value">
                                "{{ heading.text }}"
                                <br><small class="text-muted">Line {{ heading.line_number }}</small>
                            </span>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>

                {% if labels.pattern_hints.has_footnote_refs or labels.pattern_hints.has_repeated_symbols or labels.pattern_hints.has_endnote_refs or labels.pattern_hints.has_images %}
                <div class="label-section">
                    <h4>Pattern Hints</h4>
                    {% if labels.pattern_hints.has_footnote_refs %}
                    <div class="label-item">
                        <span class="label-key">Footnote Refs:</span>
                        <span class="label-value">{{ labels.pattern_hints.footnote_count }}</span>
                    </div>
                    {% endif %}
                    {% if labels.pattern_hints.has_repeated_symbols %}
                    <div class="label-item">
                        <span class="label-key">Repeated Symbol:</span>
                        <span class="label-value">{{ labels.pattern_hints.repeated_symbol }} ({{ labels.pattern_hints.repeated_symbol_count }}x)</span>
                    </div>
                    {% endif %}
                    {% if labels.pattern_hints.has_endnote_refs %}
                    <div class="label-item">
                        <span class="label-key">Endnote Markers:</span>
                        <span class="label-value">{{ labels.pattern_hints.endnote_markers|join(', ') }}</span>
                    </div>
                    {% endif %}
                    {% if labels.pattern_hints.has_images %}
                    <div class="label-item">
                        <span class="label-key">Images:</span>
                        <span class="label-value">{{ labels.pattern_hints.image_refs|length }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="navigation">
                <div style="display: flex; gap: 0.5rem;">
                    {% if page_num > 1 %}
                        <a href="{{ url_for('stage.label_structure_page_view', scan_id=scan_id, page_num=page_num-1) }}" class="nav-button">
                            ← Previous
                        </a>
                    {% else %}
                        <span class="nav-button disabled">← Previous</span>
                    {% endif %}

                    <a href="{{ url_for('stage.label_structure_view', scan_id=scan_id) }}" class="nav-button">
                        Back to Report
                    </a>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    {% if page_num < metadata.scan.pages %}
                        <a href="{{ url_for('stage.label_structure_page_view', scan_id=scan_id, page_num=page_num+1) }}" class="nav-button">
                            Next →
                        </a>
                    {% else %}
                        <span class="nav-button disabled">Next →</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
