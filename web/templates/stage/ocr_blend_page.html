{% extends "base.html" %}

{% block title %}Blend Review - Page {{ page_num }} - {{ scan_id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stage.css') }}">
<style>
.view-mode-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.view-mode-btn {
    padding: 10px 20px;
    border: 2px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.view-mode-btn:hover {
    background: #e7f3ff;
}

.view-mode-btn.active {
    background: #007bff;
    color: white;
}

.page-view {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
    height: calc(100vh - 320px);
}

.panel {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.panel-header {
    background: #f8f9fa;
    padding: 12px 15px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.image-panel .panel-content {
    background: #f8f9fa;
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

.image-panel img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.text-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #212529;
}

/* Diff view styles */
.diff-view {
    display: none;
    height: calc(100vh - 320px);
}

.diff-view.active {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.image-view {
    display: grid;
}

.image-view.hidden {
    display: none;
}

.provider-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.provider-tab {
    flex: 1;
    padding: 10px 15px;
    text-align: center;
    background: #e9ecef;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #495057;
    transition: all 0.2s;
    border-right: 1px solid #dee2e6;
}

.provider-tab:last-child {
    border-right: none;
}

.provider-tab:hover {
    background: #dee2e6;
}

.provider-tab.active {
    background: #ffffff;
    color: #007bff;
    border-bottom: 2px solid #007bff;
    margin-bottom: -2px;
}

.diff-content {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.diff-content.active {
    display: block;
}

/* Diff highlighting */
.diff-added {
    background-color: #d4edda;
    color: #155724;
}

.diff-removed {
    background-color: #f8d7da;
    color: #721c24;
    text-decoration: line-through;
}

.diff-line {
    display: block;
    padding: 2px 4px;
    margin: 1px 0;
}

.diff-stats {
    padding: 10px 15px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    font-size: 13px;
    color: #6c757d;
}

.page-nav {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    align-items: center;
}

.page-nav a {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 500;
}

.page-nav a:hover {
    background: #0056b3;
}

.page-nav a.disabled {
    background: #6c757d;
    cursor: not-allowed;
    pointer-events: none;
}

.page-nav .page-info {
    font-size: 1.1em;
    font-weight: 600;
    color: #495057;
}

.no-data {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 40px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="stage-header">
        <h2>Blend Review - Page {{ page_num }}</h2>
        <div class="book-info">
            <a href="/stage/{{ scan_id }}/ocr-pages" style="color: #007bff; text-decoration: none;">
                &larr; Back to OCR Pages Overview
            </a>
        </div>
    </div>

    <div class="view-mode-toggle">
        <button class="view-mode-btn active" onclick="switchViewMode('image')">
            Image + Blend
        </button>
        <button class="view-mode-btn" onclick="switchViewMode('diff')">
            Diff Comparison
        </button>
    </div>

    <div class="page-nav">
        {% if page_num > 1 %}
        <a href="/stage/{{ scan_id }}/ocr-pages/blend/{{ page_num - 1 }}">&larr; Previous Page</a>
        {% else %}
        <a class="disabled">&larr; Previous Page</a>
        {% endif %}

        <span class="page-info">Page {{ page_num }} of {{ blend_status.pages_blended }}</span>

        {% if page_num < blend_status.pages_blended %}
        <a href="/stage/{{ scan_id }}/ocr-pages/blend/{{ page_num + 1 }}">Next Page &rarr;</a>
        {% else %}
        <a class="disabled">Next Page &rarr;</a>
        {% endif %}
    </div>

    <!-- Image + Blend View -->
    <div id="image-view" class="page-view image-view">
        <!-- Left: Source Image -->
        <div class="panel image-panel">
            <div class="panel-header">Source Image</div>
            <div class="panel-content">
                <img src="/image/{{ scan_id }}/source/{{ page_num }}" alt="Page {{ page_num }}">
            </div>
        </div>

        <!-- Right: Blended Text -->
        <div class="panel">
            <div class="panel-header">Blended Output</div>
            <div class="panel-content">
                <pre class="text-content">{{ blend_text }}</pre>
            </div>
        </div>
    </div>

    <!-- Diff Comparison View -->
    <div id="diff-view" class="diff-view">
        <!-- Left: Blended Text -->
        <div class="panel">
            <div class="panel-header">Blended Output</div>
            <div class="panel-content">
                <pre class="text-content">{{ blend_text }}</pre>
            </div>
        </div>

        <!-- Right: Provider Diffs -->
        <div class="panel">
            <div class="provider-tabs">
                {% for provider in providers %}
                <button class="provider-tab {% if loop.first %}active{% endif %}"
                        onclick="switchProvider('{{ provider }}')">
                    {{ provider }}
                </button>
                {% endfor %}
            </div>

            {% for provider in providers %}
            <div id="diff-{{ provider }}" class="diff-content {% if loop.first %}active{% endif %}">
                {% if provider_texts[provider] %}
                <div id="diff-output-{{ provider }}" class="text-content"></div>
                <div id="diff-stats-{{ provider }}" class="diff-stats"></div>
                {% else %}
                <div class="no-data">No OCR data available for {{ provider }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
<script>
// Store texts for diff calculation
const blendText = {{ blend_text | tojson }};
const providerTexts = {{ provider_texts | tojson }};

function switchViewMode(mode) {
    const imageView = document.getElementById('image-view');
    const diffView = document.getElementById('diff-view');
    const buttons = document.querySelectorAll('.view-mode-btn');

    buttons.forEach(btn => btn.classList.remove('active'));

    if (mode === 'image') {
        imageView.classList.remove('hidden');
        diffView.classList.remove('active');
        buttons[0].classList.add('active');
    } else {
        imageView.classList.add('hidden');
        diffView.classList.add('active');
        buttons[1].classList.add('active');
        // Generate diffs on first view
        generateAllDiffs();
    }
}

function switchProvider(provider) {
    // Hide all diff contents
    const contents = document.querySelectorAll('.diff-content');
    contents.forEach(content => content.classList.remove('active'));

    // Remove active from all tabs
    const tabs = document.querySelectorAll('.provider-tab');
    tabs.forEach(tab => tab.classList.remove('active'));

    // Show selected content
    const selectedContent = document.getElementById('diff-' + provider);
    if (selectedContent) {
        selectedContent.classList.add('active');
    }

    // Add active to clicked tab
    event.target.classList.add('active');
}

let diffsGenerated = false;

function generateAllDiffs() {
    if (diffsGenerated) return;
    diffsGenerated = true;

    for (const provider of Object.keys(providerTexts)) {
        const providerText = providerTexts[provider];
        if (providerText) {
            generateDiff(provider, providerText);
        }
    }
}

function generateDiff(provider, providerText) {
    const outputEl = document.getElementById('diff-output-' + provider);
    const statsEl = document.getElementById('diff-stats-' + provider);

    if (!outputEl) return;

    // Clear existing content
    outputEl.textContent = '';

    // Use word diff for better readability
    const diff = Diff.diffWords(providerText, blendText);

    let added = 0;
    let removed = 0;

    // Build diff output using safe DOM methods
    diff.forEach(part => {
        const span = document.createElement('span');
        span.textContent = part.value;

        if (part.added) {
            span.className = 'diff-added';
            added += part.value.length;
        } else if (part.removed) {
            span.className = 'diff-removed';
            removed += part.value.length;
        }

        outputEl.appendChild(span);
    });

    // Calculate similarity
    const totalLength = Math.max(blendText.length, providerText.length);
    const changes = added + removed;
    const similarity = totalLength > 0 ? ((1 - changes / (2 * totalLength)) * 100).toFixed(1) : 100;

    // Build stats using safe DOM methods
    statsEl.textContent = '';

    const statsStrong1 = document.createElement('strong');
    statsStrong1.textContent = 'Changes: ';
    statsEl.appendChild(statsStrong1);

    const addedSpan = document.createElement('span');
    addedSpan.style.color = '#155724';
    addedSpan.textContent = '+' + added + ' chars added';
    statsEl.appendChild(addedSpan);

    statsEl.appendChild(document.createTextNode(', '));

    const removedSpan = document.createElement('span');
    removedSpan.style.color = '#721c24';
    removedSpan.textContent = '-' + removed + ' chars removed';
    statsEl.appendChild(removedSpan);

    statsEl.appendChild(document.createTextNode(' | '));

    const statsStrong2 = document.createElement('strong');
    statsStrong2.textContent = 'Similarity: ';
    statsEl.appendChild(statsStrong2);

    statsEl.appendChild(document.createTextNode(similarity + '%'));
}
</script>
{% endblock %}
