{% extends "base.html" %}

{% block title %}OCR Pages - {{ scan_id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stage.css') }}">
<style>
.ocr-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #dee2e6;
}

.back-link {
    font-size: 0.9em;
    color: #6c757d;
    text-decoration: none;
}

.back-link:hover {
    color: #007bff;
}

.provider-buttons {
    display: flex;
    gap: 10px;
}

.provider-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 500;
    white-space: nowrap;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    cursor: default;
}

.provider-btn.completed {
    background: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.provider-btn.in_progress {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.status-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.phase-status {
    display: flex;
    gap: 8px;
}

.phase-btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
}

.phase-btn.completed {
    background: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.phase-btn.in_progress {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.phase-btn.not_started {
    background: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
}

.page-viewer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
    height: calc(100vh - 250px);
}

.image-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.image-panel img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.text-panel {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 12px 15px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

.panel-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.ocr-text {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #212529;
}

.no-data {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 40px;
}

.page-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
}

.page-selector label {
    font-weight: 600;
    color: #495057;
}

.page-selector input {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1em;
}

.page-selector button {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.page-selector button:hover {
    background: #0056b3;
}

.nav-btn {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 500;
}

.nav-btn:hover {
    background: #0056b3;
    color: white;
}

.nav-btn.disabled {
    background: #6c757d;
    cursor: not-allowed;
    pointer-events: none;
}

.page-selector .current-page {
    font-weight: 600;
    color: #212529;
}

.loading {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 40px;
}

.view-toggle {
    display: flex;
    gap: 4px;
}

.view-toggle-btn {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: #e9ecef;
    color: #495057;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85em;
    transition: all 0.2s;
}

.view-toggle-btn:hover {
    background: #dee2e6;
}

.view-toggle-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.provider-selector {
    display: flex;
    gap: 4px;
}

.provider-selector.hidden {
    display: none;
}

.provider-tab {
    padding: 6px 10px;
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8em;
    color: #495057;
    transition: all 0.2s;
}

.provider-tab:hover {
    background: #dee2e6;
}

.provider-tab.active {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.diff-panel {
    display: none;
}

.diff-panel.active {
    display: block;
}

.hidden {
    display: none !important;
}

.diff-added {
    background-color: #d4edda;
    color: #155724;
}

.diff-removed {
    background-color: #f8d7da;
    color: #721c24;
    text-decoration: line-through;
}

.diff-stats {
    padding: 10px 15px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    font-size: 13px;
    color: #6c757d;
}

</style>
{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="ocr-header">
        <div>
            <a href="/" class="back-link">← Library</a>
            <h2>OCR Pages - {{ scan_id }}</h2>
            <div class="book-info">
                <span><strong>Title:</strong> {{ metadata.title }}</span>
                <span><strong>Pages:</strong> {{ ocr_data.page_range[1] }}</span>
            </div>
        </div>
        <div class="status-section">
            <!-- Phase Status -->
            <div class="phase-status">
                {% if ocr_data.phases %}
                {% for phase_name, phase_info in ocr_data.phases.items() %}
                <div class="phase-btn {{ phase_info.status }}">
                    {% if phase_info.status == 'completed' %}✓
                    {% elif phase_info.status == 'in_progress' %}⏳
                    {% else %}○{% endif %}
                    {{ phase_name | capitalize }}
                    {% if phase_info.pages_processed is defined and phase_info.total_pages is defined and phase_info.total_pages > 0 %}
                        ({{ (phase_info.pages_processed / phase_info.total_pages * 100) | int }}%)
                    {% endif %}
                </div>
                {% endfor %}
                {% endif %}
            </div>
            <!-- Provider Status -->
            <div class="provider-buttons">
                {% for provider in ocr_data.providers %}
                {% set provider_info = ocr_data.provider_data.get(provider, {}) %}
                <div class="provider-btn {{ provider_info.status | default('not_started') }}">
                    {% if provider_info.status == 'completed' %}✓
                    {% elif provider_info.status == 'in_progress' %}⏳
                    {% else %}○{% endif %}
                    {{ provider }}
                    {% if provider_info.pages_processed and provider_info.pages_processed > 0 %}
                        ({{ (provider_info.pages_processed / ocr_data.page_range[1] * 100) | int }}%)
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="page-selector">
        <label for="pageNumber">Page:</label>
        <input
            type="number"
            id="pageNumber"
            min="{{ ocr_data.page_range[0] }}"
            max="{{ ocr_data.page_range[1] }}"
            value="{{ initial_page }}"
            onkeypress="if(event.key === 'Enter') goToPage()"
        >
        <button onclick="goToPage()">Go</button>
        {% if initial_page > ocr_data.page_range[0] %}
        <a href="/stage/{{ scan_id }}/ocr-pages/{{ initial_page - 1 }}" class="nav-btn">← Prev</a>
        {% else %}
        <span class="nav-btn disabled">← Prev</span>
        {% endif %}
        {% if initial_page < ocr_data.page_range[1] %}
        <a href="/stage/{{ scan_id }}/ocr-pages/{{ initial_page + 1 }}" class="nav-btn">Next →</a>
        {% else %}
        <span class="nav-btn disabled">Next →</span>
        {% endif %}
        <span class="current-page">{{ initial_page }} / {{ ocr_data.page_range[1] }}</span>
    </div>

    <div class="page-viewer">
        <div class="image-panel">
            <h3 style="margin-top: 0;">Source Image</h3>
            <img id="pageImage" src="/image/{{ scan_id }}/source/{{ initial_page }}" alt="Page {{ initial_page }}">
        </div>

        <div class="text-panel">
            <div class="panel-header">
                <div class="view-toggle">
                    <button class="view-toggle-btn active" onclick="switchViewMode('blend')">Blend</button>
                    <button class="view-toggle-btn" onclick="switchViewMode('diff')">Diff</button>
                </div>
                <div id="provider-selector" class="provider-selector hidden">
                    {% for provider in ocr_data.providers %}
                    <button class="provider-tab {% if loop.first %}active{% endif %}" onclick="switchProvider('{{ provider }}')">
                        {{ provider }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div id="blend-content" class="panel-content">
                <div class="loading">Loading...</div>
            </div>

            <div id="diff-content" class="panel-content hidden">
                {% for provider in ocr_data.providers %}
                <div id="diff-{{ provider }}" class="diff-panel {% if loop.first %}active{% endif %}">
                    <div id="diff-output-{{ provider }}" class="ocr-text"></div>
                    <div id="diff-stats-{{ provider }}" class="diff-stats"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
<script>
const scanId = '{{ scan_id }}';
const minPage = {{ ocr_data.page_range[0] }};
const maxPage = {{ ocr_data.page_range[1] }};
const currentPage = {{ initial_page }};
const providers = {{ ocr_data.providers | tojson }};
let currentBlendText = '';
let providerTexts = {};
let currentViewMode = 'blend';

function goToPage() {
    const pageNum = parseInt(document.getElementById('pageNumber').value);
    if (pageNum >= minPage && pageNum <= maxPage) {
        window.location.href = `/stage/${scanId}/ocr-pages/${pageNum}`;
    }
}

function switchViewMode(mode) {
    currentViewMode = mode;
    const blendContent = document.getElementById('blend-content');
    const diffContent = document.getElementById('diff-content');
    const providerSelector = document.getElementById('provider-selector');
    const buttons = document.querySelectorAll('.view-toggle-btn');

    buttons.forEach(btn => btn.classList.remove('active'));

    if (mode === 'blend') {
        blendContent.classList.remove('hidden');
        diffContent.classList.add('hidden');
        providerSelector.classList.add('hidden');
        buttons[0].classList.add('active');
    } else {
        blendContent.classList.add('hidden');
        diffContent.classList.remove('hidden');
        providerSelector.classList.remove('hidden');
        buttons[1].classList.add('active');
        generateAllDiffs();
    }
}

function switchProvider(provider) {
    const panels = document.querySelectorAll('.diff-panel');
    panels.forEach(panel => panel.classList.remove('active'));

    const tabs = document.querySelectorAll('.provider-tab');
    tabs.forEach(tab => tab.classList.remove('active'));

    const selectedPanel = document.getElementById('diff-' + provider);
    if (selectedPanel) {
        selectedPanel.classList.add('active');
    }

    event.target.classList.add('active');
}

function generateAllDiffs() {
    for (const provider of providers) {
        const providerText = providerTexts[provider];
        if (providerText && currentBlendText) {
            generateDiff(provider, providerText);
        } else {
            const outputEl = document.getElementById('diff-output-' + provider);
            const statsEl = document.getElementById('diff-stats-' + provider);
            if (outputEl) {
                outputEl.textContent = '';
                const noData = document.createElement('div');
                noData.className = 'no-data';
                noData.textContent = providerText ? 'No blend text available' : 'No OCR data available for ' + provider;
                outputEl.appendChild(noData);
            }
            if (statsEl) statsEl.textContent = '';
        }
    }
}

function generateDiff(provider, providerText) {
    const outputEl = document.getElementById('diff-output-' + provider);
    const statsEl = document.getElementById('diff-stats-' + provider);

    if (!outputEl) return;

    outputEl.textContent = '';

    const diff = Diff.diffWords(currentBlendText, providerText);

    let added = 0;
    let removed = 0;

    diff.forEach(part => {
        const span = document.createElement('span');
        span.textContent = part.value;

        if (part.added) {
            span.className = 'diff-added';
            added += part.value.length;
        } else if (part.removed) {
            span.className = 'diff-removed';
            removed += part.value.length;
        }

        outputEl.appendChild(span);
    });

    const totalLength = Math.max(currentBlendText.length, providerText.length);
    const changes = added + removed;
    const similarity = totalLength > 0 ? ((1 - changes / (2 * totalLength)) * 100).toFixed(1) : 100;

    statsEl.textContent = '';
    const statsStrong1 = document.createElement('strong');
    statsStrong1.textContent = 'Provider: ';
    statsEl.appendChild(statsStrong1);

    const removedSpan = document.createElement('span');
    removedSpan.style.color = '#721c24';
    removedSpan.textContent = 'missing ' + removed + ' chars';
    statsEl.appendChild(removedSpan);

    statsEl.appendChild(document.createTextNode(', '));

    const addedSpan = document.createElement('span');
    addedSpan.style.color = '#155724';
    addedSpan.textContent = '+' + added + ' extra chars';
    statsEl.appendChild(addedSpan);

    statsEl.appendChild(document.createTextNode(' | '));

    const statsStrong2 = document.createElement('strong');
    statsStrong2.textContent = 'Similarity: ';
    statsEl.appendChild(statsStrong2);

    statsEl.appendChild(document.createTextNode(similarity + '%'));
}

async function fetchBlendText(pageNum) {
    const content = document.getElementById('blend-content');

    content.textContent = '';
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading';
    loadingDiv.textContent = 'Loading...';
    content.appendChild(loadingDiv);

    try {
        const response = await fetch(`/api/blend/${scanId}/${pageNum}`);
        content.textContent = '';

        if (!response.ok) {
            currentBlendText = '';
            const noData = document.createElement('div');
            noData.className = 'no-data';
            noData.textContent = 'No blended text available for this page';
            content.appendChild(noData);
            return;
        }

        const data = await response.json();
        currentBlendText = data.text;
        const pre = document.createElement('pre');
        pre.className = 'ocr-text';
        pre.textContent = data.text;
        content.appendChild(pre);
    } catch (error) {
        currentBlendText = '';
        content.textContent = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'no-data';
        errorDiv.textContent = 'Error loading blended text';
        content.appendChild(errorDiv);
    }
}

async function fetchProviderTexts(pageNum) {
    providerTexts = {};

    const promises = providers.map(async (provider) => {
        try {
            const response = await fetch(`/api/ocr/${scanId}/${provider}/${pageNum}`);
            if (response.ok) {
                const data = await response.json();
                providerTexts[provider] = data.text;
            }
        } catch (error) {
        }
    });

    await Promise.all(promises);

    if (currentViewMode === 'diff') {
        generateAllDiffs();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchBlendText(currentPage);
    fetchProviderTexts(currentPage);
});
</script>
{% endblock %}
