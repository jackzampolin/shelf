{% extends "base.html" %}

{% block title %}OCR Pages - {{ scan_id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stage.css') }}">
<style>
.ocr-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #dee2e6;
}

.provider-buttons {
    display: flex;
    gap: 10px;
}

.provider-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 500;
    white-space: nowrap;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    cursor: default;
}

.provider-btn.completed {
    background: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.provider-btn.in_progress {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.page-viewer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.image-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.image-panel img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.text-panel {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.tab {
    flex: 1;
    padding: 12px 20px;
    text-align: center;
    background: #e9ecef;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #495057;
    transition: all 0.2s;
    border-right: 1px solid #dee2e6;
}

.tab:last-child {
    border-right: none;
}

.tab:hover {
    background: #dee2e6;
}

.tab.active {
    background: #ffffff;
    color: #007bff;
    border-bottom: 2px solid #007bff;
    margin-bottom: -2px;
}

.tab-content {
    display: none;
    padding: 20px;
    max-height: 800px;
    overflow-y: auto;
}

.tab-content.active {
    display: block;
}

.ocr-text {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #212529;
}

.no-data {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 40px;
}

.page-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
}

.page-selector label {
    font-weight: 600;
    color: #495057;
}

.page-selector input {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1em;
}

.page-selector button {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.page-selector button:hover {
    background: #0056b3;
}

.page-selector button:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.page-selector .current-page {
    font-weight: 600;
    color: #212529;
}
</style>
{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="ocr-header">
        <div>
            <h2>üìù OCR Pages - {{ scan_id }}</h2>
            <div class="book-info">
                <span><strong>Title:</strong> {{ metadata.title }}</span>
                <span><strong>Pages:</strong> {{ ocr_data.page_range[1] }}</span>
            </div>
        </div>
        <div class="provider-buttons">
            {% for provider in ocr_data.providers %}
            {% set provider_info = ocr_data.provider_data[provider] %}
            <div class="provider-btn {{ provider_info.status }}">
                {% if provider_info.status == 'completed' %}
                    ‚úì
                {% elif provider_info.status == 'in_progress' %}
                    ‚è≥
                {% else %}
                    ‚óã
                {% endif %}
                {{ provider }}
                {% if provider_info.pages_processed > 0 %}
                    ({{ (provider_info.pages_processed / ocr_data.page_range[1] * 100) | int }}%)
                {% endif %}
                {% if provider_info.cost_usd > 0 %}
                    ${{ "%.2f"|format(provider_info.cost_usd) }}
                {% endif %}
                {% if provider_info.runtime_seconds >= 60 %}
                    ({{ "%.1fm"|format(provider_info.runtime_seconds / 60) }})
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="page-selector">
        <label for="pageNumber">Go to page:</label>
        <input
            type="number"
            id="pageNumber"
            min="{{ ocr_data.page_range[0] }}"
            max="{{ ocr_data.page_range[1] }}"
            value="1"
            onkeypress="if(event.key === 'Enter') loadPage()"
        >
        <button onclick="loadPage()">Load Page</button>
        <button onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
        <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
        <span class="current-page" id="currentPageDisplay">Page 1</span>
    </div>

    <div class="page-viewer">
        <!-- Left: Image -->
        <div class="image-panel">
            <h3 style="margin-top: 0;">Source Image</h3>
            <img id="pageImage" src="/image/{{ scan_id }}/source/1" alt="Page 1">
        </div>

        <!-- Right: Tabbed OCR Text -->
        <div class="text-panel">
            <div class="tabs">
                {% for provider in ['olm-ocr', 'mistral-ocr', 'paddle-ocr'] %}
                <button class="tab {% if loop.first %}active{% endif %}" onclick="switchTab('{{ provider }}')">
                    {{ provider }}
                </button>
                {% endfor %}
            </div>

            <div id="ocr-content">
                {% for provider in ['olm-ocr', 'mistral-ocr', 'paddle-ocr'] %}
                <div id="{{ provider }}" class="tab-content {% if loop.first %}active{% endif %}">
                    <div class="loading">Loading...</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
const scanId = '{{ scan_id }}';
const minPage = {{ ocr_data.page_range[0] }};
const maxPage = {{ ocr_data.page_range[1] }};
let currentPage = 1;
const providers = ['olm-ocr', 'mistral-ocr', 'paddle-ocr'];

function switchTab(providerId) {
    // Hide all tab contents
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => {
        content.classList.remove('active');
    });

    // Remove active class from all tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab content
    const selectedContent = document.getElementById(providerId);
    if (selectedContent) {
        selectedContent.classList.add('active');
    }

    // Add active class to selected tab
    event.target.classList.add('active');
}

async function fetchPageOCR(pageNum) {
    const promises = providers.map(async (provider) => {
        try {
            const response = await fetch(`/api/ocr/${scanId}/${provider}/${pageNum}`);
            if (!response.ok) {
                return { provider, text: null };
            }
            const data = await response.json();
            return { provider, text: data.text };
        } catch (error) {
            return { provider, text: null };
        }
    });

    const results = await Promise.all(promises);
    results.forEach(({ provider, text }) => {
        const content = document.getElementById(provider);
        // Clear existing content
        content.textContent = '';

        if (text) {
            const pre = document.createElement('pre');
            pre.className = 'ocr-text';
            pre.textContent = text;
            content.appendChild(pre);
        } else {
            const noData = document.createElement('div');
            noData.className = 'no-data';
            noData.textContent = `No OCR data available for ${provider}`;
            content.appendChild(noData);
        }
    });
}

function loadPage() {
    const pageInput = document.getElementById('pageNumber');
    const pageNum = parseInt(pageInput.value);

    if (pageNum < minPage || pageNum > maxPage) {
        alert(`Page must be between ${minPage} and ${maxPage}`);
        return;
    }

    currentPage = pageNum;

    // Update image
    const pageImage = document.getElementById('pageImage');
    pageImage.src = `/image/${scanId}/source/${pageNum}`;
    pageImage.alt = `Page ${pageNum}`;

    // Update display
    document.getElementById('currentPageDisplay').textContent = `Page ${pageNum}`;

    // Update button states
    document.getElementById('prevBtn').disabled = (pageNum <= minPage);
    document.getElementById('nextBtn').disabled = (pageNum >= maxPage);

    // Fetch OCR text for all providers
    fetchPageOCR(pageNum);
}

function previousPage() {
    if (currentPage > minPage) {
        document.getElementById('pageNumber').value = currentPage - 1;
        loadPage();
    }
}

function nextPage() {
    if (currentPage < maxPage) {
        document.getElementById('pageNumber').value = currentPage + 1;
        loadPage();
    }
}

// Load page 1 on initial load
document.addEventListener('DOMContentLoaded', () => {
    loadPage();
});
</script>
{% endblock %}
