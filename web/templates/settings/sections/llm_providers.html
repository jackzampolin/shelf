<form hx-post="/settings/api/validate"
      hx-target="#llm-providers-preview"
      hx-swap="innerHTML"
      class="config-form">
    <input type="hidden" name="section" value="llm-providers">

    <div class="form-description">
        <p>LLM providers for text processing and correction. Check "Remove" to delete a provider.</p>
    </div>

    {% for name, provider in config.llm_providers.items() %}
    <div class="provider-card" id="llm-card-{{ name }}">
        <div class="provider-header">
            <span class="provider-name">{{ name }}</span>
            <label class="remove-toggle">
                <input type="checkbox"
                       name="llm_providers.{{ name }}._remove"
                       value="true"
                       onchange="toggleProviderRemove('llm-card-{{ name }}', this.checked)">
                Remove
            </label>
        </div>

        <div class="provider-fields">
            <div class="field-row">
                <label>Type</label>
                <select name="llm_providers.{{ name }}.type">
                    <option value="openrouter" {% if provider.type == 'openrouter' %}selected{% endif %}>OpenRouter</option>
                    <option value="anthropic" {% if provider.type == 'anthropic' %}selected{% endif %}>Anthropic</option>
                    <option value="ollama" {% if provider.type == 'ollama' %}selected{% endif %}>Ollama</option>
                </select>
            </div>

            <div class="field-row">
                <label>Model *</label>
                <input type="text"
                       name="llm_providers.{{ name }}.model"
                       value="{{ provider.model }}"
                       required
                       placeholder="e.g., xai/grok-4.1-fast">
            </div>

            <div class="field-row">
                <label>Rate Limit (req/s)</label>
                <input type="number"
                       name="llm_providers.{{ name }}.rate_limit"
                       value="{{ provider.rate_limit or '' }}"
                       step="0.1"
                       placeholder="Optional">
            </div>

            <div class="field-row">
                <label>API Key Reference</label>
                <select name="llm_providers.{{ name }}.api_key_ref">
                    <option value="">Default (use type)</option>
                    {% for key_name in api_key_names %}
                    <option value="{{ key_name }}"
                            {% if provider.api_key_ref == key_name %}selected{% endif %}>
                        {{ key_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add new provider -->
    <div class="add-provider-section">
        <h4>Add New Provider</h4>
        <div class="provider-card new-provider">
            <div class="field-row">
                <label>Name *</label>
                <input type="text"
                       name="new_llm_provider.name"
                       placeholder="e.g., grok-fast">
            </div>
            <div class="field-row">
                <label>Type</label>
                <select name="new_llm_provider.type">
                    <option value="openrouter">OpenRouter</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="ollama">Ollama</option>
                </select>
            </div>
            <div class="field-row">
                <label>Model *</label>
                <input type="text"
                       name="new_llm_provider.model"
                       placeholder="e.g., xai/grok-4.1-fast">
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn-preview">Preview Changes</button>
    </div>
</form>

<div id="llm-providers-preview"></div>

<script>
function toggleProviderRemove(cardId, isRemoved) {
    const card = document.getElementById(cardId);
    if (isRemoved) {
        card.classList.add('marked-for-removal');
    } else {
        card.classList.remove('marked-for-removal');
    }
}
</script>
