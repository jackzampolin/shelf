<form hx-post="/settings/api/validate"
      hx-target="#ocr-providers-preview"
      hx-swap="innerHTML"
      class="config-form">
    <input type="hidden" name="section" value="ocr-providers">

    <div class="form-description">
        <p>OCR providers for text extraction from scanned pages. Check "Remove" to delete a provider.</p>
    </div>

    {% for name, provider in config.ocr_providers.items() %}
    <div class="provider-card" id="ocr-card-{{ name }}">
        <div class="provider-header">
            <span class="provider-name">{{ name }}</span>
            <div class="provider-actions">
                <label class="enabled-toggle">
                    <input type="checkbox"
                           name="ocr_providers.{{ name }}.enabled"
                           value="true"
                           {% if provider.enabled %}checked{% endif %}>
                    Enabled
                </label>
                <label class="remove-toggle">
                    <input type="checkbox"
                           name="ocr_providers.{{ name }}._remove"
                           value="true"
                           onchange="toggleProviderRemove('ocr-card-{{ name }}', this.checked)">
                    Remove
                </label>
            </div>
        </div>

        <div class="provider-fields">
            <div class="field-row">
                <label>Type</label>
                <select name="ocr_providers.{{ name }}.type">
                    <option value="mistral-ocr" {% if provider.type == 'mistral-ocr' %}selected{% endif %}>Mistral OCR</option>
                    <option value="deepinfra" {% if provider.type == 'deepinfra' %}selected{% endif %}>DeepInfra</option>
                    <option value="openrouter" {% if provider.type == 'openrouter' %}selected{% endif %}>OpenRouter</option>
                </select>
            </div>

            <div class="field-row">
                <label>Model</label>
                <input type="text"
                       name="ocr_providers.{{ name }}.model"
                       value="{{ provider.model or '' }}"
                       placeholder="e.g., allenai/olmOCR-7B">
            </div>

            <div class="field-row">
                <label>Rate Limit (req/s)</label>
                <input type="number"
                       name="ocr_providers.{{ name }}.rate_limit"
                       value="{{ provider.rate_limit or '' }}"
                       step="0.1"
                       placeholder="e.g., 6.0">
            </div>

            <div class="field-row">
                <label>API Key Reference</label>
                <select name="ocr_providers.{{ name }}.api_key_ref">
                    <option value="">Default (use type)</option>
                    {% for key_name in api_key_names %}
                    <option value="{{ key_name }}"
                            {% if provider.api_key_ref == key_name %}selected{% endif %}>
                        {{ key_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add new provider -->
    <div class="add-provider-section">
        <h4>Add New Provider</h4>
        <div class="provider-card new-provider">
            <div class="field-row">
                <label>Name *</label>
                <input type="text"
                       name="new_ocr_provider.name"
                       placeholder="e.g., olmocr">
            </div>
            <div class="field-row">
                <label>Type</label>
                <select name="new_ocr_provider.type">
                    <option value="deepinfra">DeepInfra</option>
                    <option value="mistral-ocr">Mistral OCR</option>
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>
            <div class="field-row">
                <label>Model</label>
                <input type="text"
                       name="new_ocr_provider.model"
                       placeholder="e.g., allenai/olmOCR-7B">
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn-preview">Preview Changes</button>
    </div>
</form>

<div id="ocr-providers-preview"></div>

<script>
function toggleProviderRemove(cardId, isRemoved) {
    const card = document.getElementById(cardId);
    if (isRemoved) {
        card.classList.add('marked-for-removal');
    } else {
        card.classList.remove('marked-for-removal');
    }
}
</script>
