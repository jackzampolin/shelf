{% extends "base.html" %}

{% block title %}Labels Viewer - {{ scan_id }}{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="stage-header">
        <h2>üè∑Ô∏è Labels Viewer - {{ scan_id }}</h2>
        <a href="/stage/{{ scan_id }}/labels" class="back-link">‚Üê Back to Overview</a>
    </div>

    <!-- Page Data Viewer -->
    <div class="data-viewer">
        <div class="data-header">
            <h3>üìñ Block Classification View</h3>
            <div class="page-selector">
                <label for="page-input">Page:</label>
                <input type="number"
                       id="page-input"
                       value="{{ current_page }}"
                       min="1"
                       max="{{ all_pages[-1] }}"
                       onkeyup="if(event.key==='Enter') window.location.href='/stage/{{ scan_id }}/labels/viewer?page=' + this.value">
                <span class="page-info">of {{ all_pages[-1] }}</span>
                {% if current_page > 1 %}
                <button onclick="window.location.href='/stage/{{ scan_id }}/labels/viewer?page={{ current_page - 1 }}'">‚Üê Previous</button>
                {% else %}
                <button disabled>‚Üê Previous</button>
                {% endif %}
                {% if current_page < all_pages[-1] %}
                <button onclick="window.location.href='/stage/{{ scan_id }}/labels/viewer?page={{ current_page + 1 }}'">Next ‚Üí</button>
                {% else %}
                <button disabled>Next ‚Üí</button>
                {% endif %}
            </div>
        </div>

        <!-- Page Metadata -->
        {% if stage_data %}
        <div class="page-metadata">
            <div class="metadata-item">
                <span class="label">Printed Page:</span>
                <span class="value">{{ stage_data.printed_page_number or 'Not detected' }}</span>
            </div>
            <div class="metadata-item">
                <span class="label">Numbering Style:</span>
                <span class="value">{{ stage_data.numbering_style or 'none' }}</span>
            </div>
            <div class="metadata-item">
                <span class="label">Region:</span>
                <span class="value region-badge region-{{ stage_data.page_region or 'unknown' }}">
                    {{ (stage_data.page_region or 'unknown')|replace('_', ' ')|title }}
                </span>
            </div>
            <div class="metadata-item">
                <span class="label">Avg Confidence:</span>
                <span class="value">{{ "%.3f"|format(stage_data.avg_classification_confidence) }}</span>
            </div>
        </div>
        {% endif %}

        <div class="two-panel">
            <!-- Image Panel with Classification Overlays -->
            <div class="image-panel">
                <h4>Page Image with Block Classifications</h4>
                <div class="image-wrapper">
                    <img id="page-image"
                         src="/image/{{ scan_id }}/{{ current_page }}"
                         alt="Page {{ current_page }}"
                         data-width="{{ image_width }}"
                         data-height="{{ image_height }}">
                    <canvas id="bbox-canvas"></canvas>
                </div>
                <div class="legend-box">
                    <h5>Block Type Legend</h5>
                    <div class="legend-grid">
                        <div class="legend-item"><span class="color-box" style="background:#E74C3C"></span> Chapter Heading</div>
                        <div class="legend-item"><span class="color-box" style="background:#E67E22"></span> Section Heading</div>
                        <div class="legend-item"><span class="color-box" style="background:#3498DB"></span> Body Text</div>
                        <div class="legend-item"><span class="color-box" style="background:#95A5A6"></span> Header/Footer</div>
                        <div class="legend-item"><span class="color-box" style="background:#9B59B6"></span> Page Number</div>
                        <div class="legend-item"><span class="color-box" style="background:#F1C40F"></span> Footnote</div>
                        <div class="legend-item"><span class="color-box" style="background:#2ECC71"></span> Table</div>
                        <div class="legend-item"><span class="color-box" style="background:#34495E"></span> Other</div>
                    </div>
                </div>
            </div>

            <!-- Classifications Panel -->
            <div class="classifications-panel">
                <h4>Block Classifications</h4>
                {% if stage_data and stage_data.blocks %}
                    {% for block in stage_data.blocks %}
                    <div class="classification-block">
                        <div class="block-header">
                            <span class="block-num">Block {{ block.block_num }}</span>
                            <span class="block-type type-{{ block.classification }}">
                                {{ block.classification|replace('_', ' ')|title }}
                            </span>
                            <span class="confidence-badge {% if block.classification_confidence >= 0.90 %}conf-high{% elif block.classification_confidence >= 0.80 %}conf-medium{% else %}conf-low{% endif %}">
                                {{ "%.2f"|format(block.classification_confidence) }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No classification data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .stage-header h2 {
        margin: 0;
    }

    .back-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .data-viewer {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .data-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
    }

    .data-header h3 {
        margin: 0;
    }

    .page-selector {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .page-selector input[type="number"] {
        width: 80px;
        padding: 8px 12px;
        border: 1px solid var(--light);
        border-radius: 4px;
        font-size: 0.9em;
        text-align: center;
    }

    .page-info {
        color: var(--text-secondary);
        font-size: 0.9em;
    }

    .page-selector button {
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .page-selector button:hover:not(:disabled) {
        background: #2980b9;
    }

    .page-selector button:disabled {
        background: var(--light);
        color: var(--text-secondary);
        cursor: not-allowed;
    }

    .page-metadata {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        flex-wrap: wrap;
    }

    .metadata-item {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .metadata-item .label {
        font-weight: 600;
        font-size: 0.9em;
        color: var(--text-secondary);
    }

    .metadata-item .value {
        font-family: 'Monaco', monospace;
        font-size: 0.9em;
    }

    .region-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.85em;
    }

    .region-front_matter { background: #fef5e7; color: #f39c12; }
    .region-body { background: #ebf5fb; color: #3498db; }
    .region-back_matter { background: #fdecea; color: #e74c3c; }
    .region-toc_area { background: #f4ecf7; color: #9b59b6; }
    .region-unknown { background: #ecf0f1; color: #95a5a6; }

    .two-panel {
        display: flex;
        gap: 20px;
        height: 70vh;
    }

    .image-panel {
        flex: 0 0 50%;
        overflow-y: auto;
        border: 1px solid var(--light);
        border-radius: 4px;
        padding: 15px;
    }

    .classifications-panel {
        flex: 1;
        overflow-y: auto;
        border: 1px solid var(--light);
        border-radius: 4px;
        padding: 15px;
    }

    .image-panel h4, .classifications-panel h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--dark);
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--light);
        padding-bottom: 8px;
    }

    .image-wrapper {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
    }

    .image-wrapper img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 4px;
    }

    .image-wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .legend-box {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .legend-box h5 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 0.9em;
        color: var(--dark);
    }

    .legend-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        font-size: 0.85em;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .color-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .classification-block {
        margin-bottom: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid var(--primary);
    }

    .block-header {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .block-num {
        font-weight: 600;
        font-size: 0.9em;
        color: var(--dark);
    }

    .block-type {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
        background: #ecf0f1;
        color: var(--dark);
    }

    .confidence-badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        font-family: 'Monaco', monospace;
        font-weight: 600;
    }

    .conf-high {
        background: #d4edda;
        color: #155724;
    }

    .conf-medium {
        background: #fff3cd;
        color: #856404;
    }

    .conf-low {
        background: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    @media (max-width: 1200px) {
        .two-panel {
            flex-direction: column;
            height: auto;
        }

        .image-panel {
            flex: none;
            max-height: 500px;
        }

        .classifications-panel {
            flex: none;
            min-height: 300px;
        }
    }
</style>

<script>
// Inject label data for canvas drawing
window.labelData = {{ stage_data | tojson | safe }};
window.ocrData = {{ ocr_data | tojson | safe }};

// Block type color mapping
const BLOCK_TYPE_COLORS = {
    'chapter_heading': '#E74C3C',
    'section_heading': '#E67E22',
    'body': '#3498DB',
    'header': '#95A5A6',
    'footer': '#95A5A6',
    'page_number': '#9B59B6',
    'footnote': '#F1C40F',
    'endnotes': '#F1C40F',
    'table': '#2ECC71',
    'figure': '#16A085',
    'caption': '#8E44AD',
    'quote': '#D35400',
    'default': '#34495E'
};

function getBlockColor(blockType) {
    return BLOCK_TYPE_COLORS[blockType] || BLOCK_TYPE_COLORS['default'];
}

// Draw bounding boxes on canvas
function drawBoundingBoxes() {
    const img = document.getElementById('page-image');
    const canvas = document.getElementById('bbox-canvas');

    if (!img || !canvas || !window.ocrData || !window.labelData) return;

    const ctx = canvas.getContext('2d');

    // Match canvas size to image display size
    canvas.width = img.offsetWidth;
    canvas.height = img.offsetHeight;

    // Get image dimensions from data attributes
    const imgWidth = parseInt(img.dataset.width);
    const imgHeight = parseInt(img.dataset.height);

    if (!imgWidth || !imgHeight) return;

    // Calculate scale
    const scaleX = canvas.width / imgWidth;
    const scaleY = canvas.height / imgHeight;

    // Draw each labeled block
    if (window.labelData.blocks && window.ocrData.blocks) {
        window.labelData.blocks.forEach((labelBlock) => {
            const blockNum = labelBlock.block_num;
            const ocrBlock = window.ocrData.blocks[blockNum];

            if (!ocrBlock || !ocrBlock.bbox) return;

            const bbox = ocrBlock.bbox;

            // Scale coordinates
            const x = bbox.x0 * scaleX;
            const y = bbox.y0 * scaleY;
            const width = (bbox.x1 - bbox.x0) * scaleX;
            const height = (bbox.y1 - bbox.y0) * scaleY;

            // Color based on block type
            const color = getBlockColor(labelBlock.classification);

            // Draw rectangle
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, width, height);

            // Fill with semi-transparent color
            ctx.fillStyle = color.replace(')', ', 0.1)').replace('#', 'rgba(').replace(/^rgba\(([^,]+)/, (m, hex) => {
                const r = parseInt(hex.slice(0, 2), 16);
                const g = parseInt(hex.slice(2, 4), 16);
                const b = parseInt(hex.slice(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}`;
            });
            ctx.fillRect(x, y, width, height);

            // Draw block number
            ctx.fillStyle = color;
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText(String(blockNum + 1), x + 5, y + 18);
        });
    }
}

// Redraw on window resize
window.addEventListener('resize', drawBoundingBoxes);

// Draw on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        const img = document.getElementById('page-image');
        if (img) {
            if (img.complete) {
                drawBoundingBoxes();
            } else {
                img.addEventListener('load', drawBoundingBoxes);
            }
        }
    });
} else {
    const img = document.getElementById('page-image');
    if (img) {
        if (img.complete) {
            drawBoundingBoxes();
        } else {
            img.addEventListener('load', drawBoundingBoxes);
        }
    }
}
</script>
{% endblock %}
